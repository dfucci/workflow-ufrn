<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:a4j="http://richfaces.org/a4j"
    template="/layout/template.xhtml">
	<ui:define name="body">
	<h:panelGroup>
		<a4j:commandButton action="#" value="#{messages['layout.text.workflow.comments']}" id="observationModal" >
			<rich:componentControl for="panelObservation" attachTo="observationModal" operation="show" event="onclick"/>
		</a4j:commandButton>
		<h:outputText value="   " />
    	<h:commandButton action="#{report.analysis}" title="graph" value="#{messages['layout.text.workflow.analysis']}"/>
	</h:panelGroup>
	<br />
	
		<ui:repeat var="process" value="#{report.workflow.processDefinitions}">
			<rich:simpleTogglePanel switchType="client" label="#{process.name}" opened="false">	
				<h:outputText value="#{messages['layout.text.workflow.notStarted']}..." rendered="#{!process.workflow.started}"/>
				
				<ui:repeat var="taskNode" value="#{process.taskNodes}">
					<rich:simpleTogglePanel switchType="client" label="#{taskNode.name}" opened="true"
											rendered="#{taskNode.startState eq null}" >	
						<ui:repeat value="#{taskNode.userExecutions}" var="userExecution" >
							<rich:panel header="#{userExecution.userAssignment.user.name}" style="width: 300px; height: 180px; float: left;" >
								<h:panelGrid columns="2">
									<h:outputLabel value="#{messages['layout.text.workflow.wastedTime']}" />
									<h:outputText value="#{userExecution.wastedTimeString}" ></h:outputText>
								
									<h:outputLabel value="#{messages['layout.text.workflow.startedAt']}" />
									<h:outputText value="#{userExecution.startedAt.time}" >
										<f:convertDateTime pattern="MM/dd/yyyy HH:mm:ss" />
									</h:outputText>
									
									<h:outputLabel value="#{messages['layout.text.workflow.finishedAt']}" />
									<h:outputText value="#{userExecution.finishedAt.time}" >
										<f:convertDateTime pattern="MM/dd/yyyy HH:mm:ss" />
									</h:outputText>
									
									<h:outputLabel value="#{messages['layout.text.workflow.pauseTime']}" />
									<h:outputText value="" rendered="#{userExecution.wastedBreakTime eq 0}"/>
									<h:outputLink id="breakLink" rendered="#{userExecution.wastedBreakTime gt 0}"  value="#" >
										<h:outputText value="#{userExecution.wastedBreakTimeString}" />
										<rich:componentControl for="breakModal" attachTo="breakLink" operation="show" event="onclick"/>
									</h:outputLink>
								    
								    <h:outputLabel value="#{messages['layout.text.workflow.timeActivities']}" />
									<h:outputLink value="#" id="taskTime">
									        #{messages['layout.text.show']} 
									        <rich:componentControl for="taskTimeModal" attachTo="taskTime" operation="show" event="onclick"/>
									 </h:outputLink>
									 
									<h:outputLabel value="#{messages['layout.text.workflow.outputArtifacts']}" />
									<h:outputLink value="#" id="artefacts">
									        #{messages['layout.text.download']} 
									        <rich:componentControl for="artefactsModal" attachTo="artefacts" operation="show" event="onclick"/>
									 </h:outputLink>
									
									<h:outputLabel value="#{messages['layout.text.workflow.comment']}" />
									<h:outputLink value="#" id="comment" rendered="#{userExecution.comment.length() > 0}">
									        #{messages['layout.text.show']}
									        <rich:componentControl for="commentModal" attachTo="comment" operation="show" event="onclick"/>
									 </h:outputLink>
								</h:panelGrid>
							</rich:panel>
							
							<rich:modalPanel id="commentModal" width="500">
						        <f:facet name="header">
						            <h:panelGroup>
						                <h:outputText value="#{messages['layout.text.workflow.comment']}"></h:outputText>
						            </h:panelGroup>
						        </f:facet>
						        <f:facet name="controls">
						            <h:panelGroup>
						                <h:graphicImage value="/img/close.png" styleClass="hidelink" id="hidelink"/>
						                <rich:componentControl for="commentModal" attachTo="hidelink" operation="hide" event="onclick"/>
						            </h:panelGroup>
						        </f:facet>
						        <h:outputText value="#{userExecution.comment}" />
						    </rich:modalPanel>
						    
							<rich:modalPanel id="artefactsModal" width="710" >
						        <f:facet name="header">
						            <h:panelGroup>
						                <h:outputText value="#{messages['layout.text.workflow.outputArtifacts']}"></h:outputText>
						            </h:panelGroup>
						        </f:facet>
						        <f:facet name="controls">
						            <h:panelGroup>
						                <h:graphicImage value="/img/close.png" styleClass="hidelink" id="hidelinkArtefacts"/>
						                <rich:componentControl for="artefactsModal" attachTo="hidelinkArtefacts" operation="hide" event="onclick"/>
						            </h:panelGroup>
						        </f:facet>
						          <h:panelGrid columns="2">
						           <h:outputLabel value="#{messages['layout.text.workflow.activity']}: #{taskNode.name}" rendered="#{taskNode.outArtefacts.size() gt 0}" />
							       <rich:dataTable style="width: 650px;" rendered="#{taskNode.outArtefacts.size() gt 0}" value="#{taskNode.outArtefacts}" var="artefact" id="taskNodeArtefacts">
											<h:column>
												<f:facet name="header">#{messages['layout.text.workflow.name']}</f:facet>
												<h:outputText value="#{artefact.name}" />
											</h:column>
											<h:column>
												<h:commandLink value="#{messages['layout.text.download']}" action="#{sendFile.sendFile(artefact.get(userExecution))}"
												 rendered="#{artefact.get(userExecution) != null}"
								 				 status="block"
								 				 target="_blank">
					 				 			</h:commandLink>
					 				 		</h:column>
							       </rich:dataTable>
						          </h:panelGrid>
							       <ui:repeat var="task" value="#{taskNode.tasks}">
										     <h:panelGrid columns="2">
								       <h:outputLabel value="#{messages['layout.text.workflow.task']}: #{task.name}" rendered="#{task.outArtefacts.size() gt 0}" />
								       <rich:dataTable style="width: 500px;" rendered="#{task.outArtefacts.size() gt 0}" value="#{task.outArtefacts}" var="artefact" id="taskArtefacts">
												<h:column>
													<f:facet name="header">#{messages['layout.text.workflow.name']}</f:facet>
													<h:outputText value="#{artefact.name}" />
												</h:column>
												<h:column>
													<h:commandLink value="#{messages['layout.text.download']}" action="#{sendFile.sendFile(artefact.get(userExecution))}"
													 rendered="#{artefact.get(userExecution) != null}"
									 				 status="block"
									 				 target="_blank">
						 				 			</h:commandLink>
						 				 		</h:column>
								       </rich:dataTable>
								     </h:panelGrid>
							       </ui:repeat>
						    </rich:modalPanel>
							
							<rich:modalPanel id="taskTimeModal" width="500">
						        <f:facet name="header">
						            <h:panelGroup>
						                <h:outputText value="#{messages['layout.text.workflow.timeActivities']}"></h:outputText>
						            </h:panelGroup>
						        </f:facet>
						        <f:facet name="controls">
						            <h:panelGroup>
						                <h:graphicImage value="/img/close.png" styleClass="hidelink" id="hidelinktaskTimeModal"/>
						                <rich:componentControl for="taskTimeModal" attachTo="hidelinktaskTimeModal" operation="hide" event="onclick"/>
						            </h:panelGroup>
						        </f:facet>
						        <rich:dataTable rendered="#{userExecution.taskNode.tasks.size() gt 0}" value="#{userExecution.taskNode.tasks}" var="task" id="taskTimeTable">
											<h:column>
												<f:facet name="header">#{messages['layout.text.workflow.activity']}</f:facet>
												<h:outputText value="#{task.name}" />
											</h:column>
											<h:column>
												<f:facet name="header">#{messages['layout.text.workflow.time']}</f:facet>
												<h:outputText value="#{userExecution.getTaskExecution(task).wastedTimeString}" />
					 				 		</h:column>
					 				 		<h:column>
												<f:facet name="header">#{messages['layout.text.workflow.pauseTime']}</f:facet>
												<h:outputText value="#{userExecution.getTaskExecution(task).wastedBreakTimeString}" />
					 				 		</h:column>
							    </rich:dataTable>
						    </rich:modalPanel>
						    
							<rich:modalPanel id="breakModal" width="500">
						        <f:facet name="header">
						            <h:panelGroup>
						                <h:outputText value="#{messages['layout.text.workflow.comment']}"></h:outputText>
						            </h:panelGroup>
						        </f:facet>
						        <f:facet name="controls">
						            <h:panelGroup>
						                <h:graphicImage value="/img/close.png" styleClass="hidelink" id="hidelinkBreakes"/>
						                <rich:componentControl for="breakModal" attachTo="hidelinkBreakes" operation="hide" event="onclick"/>
						            </h:panelGroup>
						        </f:facet>
						        <rich:dataTable rendered="#{userExecution.breakes.size() gt 0}" value="#{userExecution.breakes}" var="break" id="userExecutionBreakes">
											<h:column>
												<f:facet name="header">#{messages['layout.text.workflow.pauseTime']}</f:facet>
												<h:outputText value="#{break.wastedTimeString}" />
											</h:column>
											<h:column>
												<f:facet name="header">#{messages['layout.text.workflow.pauseReason']}</f:facet>
												<h:outputText value="#{break.reason}" />
					 				 		</h:column>
							       </rich:dataTable>
						    </rich:modalPanel>
						</ui:repeat>
					</rich:simpleTogglePanel>
				</ui:repeat>
			</rich:simpleTogglePanel>
		</ui:repeat>
	</ui:define>
	
	<ui:define name="modal">
		<rich:modalPanel id="panelObservation" width="700" height="500"  autosized="true" >
	        <f:facet name="header">
	            <h:panelGroup>
	                <h:outputText value="#{messages['layout.text.workflow.observations']}"></h:outputText>
	            </h:panelGroup>
	        </f:facet>
	        <f:facet name="controls">
	            <h:panelGroup>
	                <h:graphicImage value="/img/close.png" styleClass="hidelink" id="hidelink"/>
	                <rich:componentControl for="panelObservation" attachTo="hidelink" operation="hide" event="onclick"/>
	            </h:panelGroup>
	        </f:facet>
	        <h:panelGroup>
		        <h:form name="observationForm" id="observationForm">
		        	<h:panelGrid columns="2">
			         	<h:inputTextarea value="#{report.observation.comment}" />
			         	<a4j:commandButton action="#{report.saveObservation()}" value="#{messages['layout.text.save']}" reRender="observationForm"></a4j:commandButton>
		        	</h:panelGrid>
		    
		        	<rich:dataTable value="#{report.workflow.observations}" var="observation" rows="5">
		        		<h:column>
		        			<h:outputText value="#{observation.createdAt.time}" >
		        				<f:convertDateTime pattern="MM/dd/yyyy HH:mm" />
		        			</h:outputText>
		        			<br /><br />
		        			<h:outputText value="#{observation.comment}" />
		        		</h:column>
		        		<h:column>
		        			<a4j:commandLink value="#{messages['layout.text.remove']}" action="#{report.removeObservation(observation)}" reRender="observationForm" />
		        		</h:column>
		        		<f:facet name="footer">
			                <rich:datascroller id="ds" renderIfSinglePage="true"></rich:datascroller>
			            </f:facet>
		        	</rich:dataTable>
			    </h:form>
	        </h:panelGroup>
	     </rich:modalPanel>
	</ui:define>
</ui:composition>
