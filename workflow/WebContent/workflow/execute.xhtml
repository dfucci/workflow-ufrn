<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:a4j="http://richfaces.org/a4j"
    template="/layout/template.xhtml">
	<ui:define name="body">
		<rich:simpleTogglePanel switchType="client" label="#{executer.currentProcess.workflow.title}" opened="false" >
			<h:outputText value="#{executer.currentProcess.workflow.description}" />
		</rich:simpleTogglePanel>
		<br />
								 
		<rich:panel header="#{executer.currentTaskNode.name}" id="panelTask" rendered="#{executer.currentTaskNode != null}">
			<h:outputText value="#{executer.currentTaskNode.description}" />
			<rich:dataList value="#{executer.currentTaskNode.inArtefacts}" var="artefact" rendered="#{executer.currentTaskNode.inArtefacts.size() gt 0}">
				<h:outputText value="#{artefact.name} " />
				<h:commandLink value="Download" rendered="#{artefact.artefactFiles.size gt 0}"
								action="#{sendFile.sendFile(artefact.artefactFiles.get(0))}"
				 				target="_blank">
				</h:commandLink>
			</rich:dataList>
			<br /><br />
			
			<h:panelGroup rendered="#{executer.currentUserExecution != null}">
				<h:panelGrid columns="2">
					<h:outputLabel value="Enviar Artefatos:" rendered="#{executer.currentTaskNode.outArtefacts.size() gt 0}"/>
					<rich:dataTable value="#{executer.currentTaskNode.outArtefacts}" var="artefact"
					id="taskNodeArtefacts" rendered="#{executer.currentTaskNode.outArtefacts.size() gt 0}">
						<h:column>
							<f:facet name="header">Nome</f:facet>
							<h:outputText value="#{artefact.name}" />
						</h:column>
						<h:column>
							<f:facet name="header"></f:facet>
							
							<h:panelGroup rendered="#{artefact.get(executer.currentUserExecution) == null}">
								<a4j:commandLink value="Enviar" action="#{executer.setCurrentArtefact(artefact)}" id="enviarModal"
								 				 reRender="uploadArtefact">
									<rich:componentControl for="panelArtefact" attachTo="enviarModal" operation="show" event="onclick"/>
								</a4j:commandLink>
							</h:panelGroup>
							<h:panelGroup rendered="#{artefact.get(executer.currentUserExecution) != null}">
								<h:panelGroup rendered="#{executer.currentUserExecution.finishedAt == null}" >
									<a4j:commandLink value="Remover" action="#{executer.removeArtefact(artefact)}"
									 				 reRender="taskNodeArtefacts">
									</a4j:commandLink>
									<h:outputText value=" | " />
								</h:panelGroup>
								<h:commandLink value="Download" action="#{sendFile.sendFile(artefact.get(executer.currentUserExecution))}"
								 				 target="_blank">
								</h:commandLink>							
							</h:panelGroup>
							
						</h:column>
					</rich:dataTable>
					
					<h:outputLabel value="Comentário:" for="userExecutionComment"/>
					<h:inputTextarea id="userExecutionComment" value="#{executer.currentUserExecution.comment}"
					 disabled="#{executer.currentUserExecution.finishedAt != null}"
					 rendered="#{executer.currentUserExecution != null}" />
				</h:panelGrid>
				<h:panelGroup id="tasks">
					<ui:repeat var="task" value="#{executer.currentTaskNode.tasks}">
						<br />
						<rich:simpleTogglePanel switchType="client" label="#{task.name}" opened="true">
							<h:outputText value="#{task.description}" />
							<rich:dataList value="#{task.inArtefacts}" var="artefact" rendered="#{task.inArtefacts.size() gt 0}">
								<h:outputText value="#{artefact.name} " /> 
								<h:commandLink value="Download" rendered="#{artefact.artefactFiles.size gt 0}"
												action="#{sendFile.sendFile(artefact.artefactFiles.get(0))}"
								 				target="_blank">
								</h:commandLink>
							</rich:dataList>
							<br /><br />
							<h:panelGrid columns="2">
								<h:outputLabel value="Enviar Artefatos:" rendered="#{task.outArtefacts.size() gt 0}"/>
								<rich:dataTable value="#{task.outArtefacts}"
								 style="width:500px" var="artefact" rendered="#{task.outArtefacts.size() gt 0}">
									<h:column>
										<f:facet name="header">Nome</f:facet>
										<h:outputText value="#{artefact.name}" />
									</h:column>
									<h:column>
										<f:facet name="header"></f:facet>
										
										<h:panelGroup rendered="#{artefact.get(executer.currentUserExecution) == null}">
											<a4j:commandLink value="Enviar" action="#{executer.setCurrentArtefact(artefact)}" id="sendModal"
											 				 reRender="uploadArtefact">
												<rich:componentControl for="panelArtefact" attachTo="sendModal" operation="show" event="onclick"/>
											</a4j:commandLink>
										</h:panelGroup>
										<h:panelGroup rendered="#{artefact.get(executer.currentUserExecution) != null}">
											<h:panelGroup rendered="#{executer.currentUserExecution.finishedAt == null}" >
												<a4j:commandLink value="Remover" action="#{executer.removeArtefact(artefact)}"
												 				 reRender="tasks">
												</a4j:commandLink>
												<h:outputText value=" | " />
											</h:panelGroup>
											<h:commandLink value="Download" action="#{sendFile.sendFile(artefact.get(executer.currentUserExecution))}"
											 				 target="_blank">
											</h:commandLink>							
										</h:panelGroup>
										
									</h:column>
								</rich:dataTable>
							</h:panelGrid>
						</rich:simpleTogglePanel>
					</ui:repeat>
				</h:panelGroup>
			</h:panelGroup>
		</rich:panel>
		
		<rich:panel header="#{executer.currentJoin.name}" rendered="#{executer.currentJoin != null}">
			<h:outputText value="#{executer.currentJoin.description}" />
		</rich:panel>
		
		<rich:panel header="#{executer.endState.name}" rendered="#{executer.endState != null}">
			<h:outputText value="#{executer.endState.description}" />
		</rich:panel>
		
		<h:panelGroup>
		
			<ui:repeat var="transition" value="#{executer.transitions}">
				<h:commandButton action="#{executer.next(transition)}" value="#{((executer.currentUserExecution.finishedAt == null or executer.currentTaskNode == null) ? transition.title : 'Pular tarefa já executada')}"
								 onclick="#{((executer.currentUserExecution.finishedAt == null and executer.currentTaskNode != null) ? 'javascript:return confirm(\'Você tem certeza?\')' : '')}"
								 styleClass="executeButton"/>
			</ui:repeat>

			<h:commandButton action="#{executer.startBreak}" value="Pausar" 
								 rendered="#{executer.currentUserExecution.finishedAt == null and executer.currentTaskNode != null}"
								 onclick="javascript:return confirm('Você tem certeza?')"
								 styleClass="executeButton">
			</h:commandButton>

			<h:commandButton action="#{executer.next(null)}" value="#{((executer.currentUserExecution.finishedAt == null or executer.currentTaskNode == null) ? 'Finalizar' : 'Pular tarefa já executada')}"
							 styleClass="executeButton"
							 rendered="#{executer.currentTaskNode != null and executer.transitions.size eq 0}"	 
							 />
		</h:panelGroup>
	</ui:define>
	
	<ui:define name="modal">
		<rich:modalPanel id="panelBreak" showWhenRendered="true" rendered="#{executer.currentUserExecution.break}" autosized="true" >
	        <f:facet name="header">
	            <h:panelGroup>
	                <h:outputText value="Break"></h:outputText>
	            </h:panelGroup>
	        </f:facet>
	        <h:panelGroup>
		        <h:form name="breakForm">
					<h:outputLabel value="Motivo da pausa:" for="breakReason"/>
					<h:inputTextarea id="breakReason" value="#{executer.currentUserExecution.openedBreak.reason}" >
						<a4j:support event="onkeyup" status="noblock" reRender="stopBreakButton" ajaxSingle="true" ignoreDupResponses="true"/>
					</h:inputTextarea>
					<h:commandButton id="stopBreakButton" reRender="panelBreak" action="#{executer.stopBreak}" value="Continuar"
						styleClass="executeButton" disabled="#{executer.currentUserExecution.openedBreak.reason.isEmpty()}"/>
			    </h:form>
	        </h:panelGroup>
	     </rich:modalPanel>
	
		 <rich:modalPanel id="panelArtefact" autosized="true">
	        <f:facet name="header">
	            <h:panelGroup>
	                <h:outputText value="Upload"></h:outputText>
	            </h:panelGroup>
	        </f:facet>
	        <f:facet name="controls">
	            <h:panelGroup>
	                <h:graphicImage value="/img/close.png" styleClass="hidelink" id="hidelink"/>
	                <rich:componentControl for="panelArtefact" attachTo="hidelink" operation="hide" event="onclick"/>
	            </h:panelGroup>
	        </f:facet>
	        <h:panelGroup id="uploadArtefact">
		        <h:form enctype="multipart/form-data">
						<rich:fileUpload
							uploadControlLabel="Enviar"
							immediateUpload="false"
							listHeight="70px;"
				            noDuplicate="true" listWidth="350px;" 
				            locale="pt-BR" 
				            autoclear="false"
				            
				            maxFilesQuantity="1" 
				            cancelEntryControlLabel="Limpar"
				            transferErrorLabel="Erro ao importar arquivo"           
				            fileUploadListener="#{executer.uploadArtefact}"
				            onfileuploadcomplete="refreshModal()">
				        </rich:fileUpload>
			    </h:form>
	        </h:panelGroup>
	    </rich:modalPanel>
	    <a4j:jsFunction name="refreshModal" reRender="panelArtefact,tasks,taskNodeArtefacts" />
	</ui:define>
</ui:composition>
